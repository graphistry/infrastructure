---
- name: Get the latest release of nvidia-docker
  get_url: "dest=/tmp/nvidia-docker.rpm url=https://github.com/NVIDIA/nvidia-docker/releases/download/v1.0.0-rc.3/nvidia-docker-1.0.0.rc.3-1.x86_64.rpm"

- name: Install nvidia-docker
  command: rpm -i /tmp/nvidia-docker.rpm
  become: yes
  become_user: root

- name: Run nvidia-docker at boot
  become: yes
  become_user: root
  command: chkconfig nvidia-docker on
  notify:
    - Reboot server
    - Wait for server to restart

- meta: flush_handlers


- name: Run the cljs convolution demo
  command: nvidia-docker run -d --name cljstest -p 80:3001 graphistry/cljs:1.0

- name: Get the opencl version
  command: bash -c "curl 'localhost/?mode=opencl' | sed -E -e 's/[0-9]+ ms /0 ms/' | sha256sum       > /tmp/sha"

- name: Check against the straight JS version
  command: bash -c "curl 'localhost/'             | sed -E -e 's/[0-9]+ ms /0 ms/' | sha256sum --check /tmp/sha"

- name: Stop the cljs demo
  command: docker rm -f cljstest
